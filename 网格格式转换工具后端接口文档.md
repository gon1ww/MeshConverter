# 网格格式转换工具后端接口文档
## 文档概述
### 1.1 文档目的
本文档定义网格格式转换工具（MeshFormatConverter）的后端核心接口，涵盖网格数据存储、多格式读写、格式转换、网格处理等能力，为开发人员提供接口使用规范、参数说明、返回值定义及使用示例。

### 1.2 适用范围
- 开发人员：用于实现网格格式转换工具的后端逻辑开发、扩展新格式支持；
- 集成人员：用于将该工具集成到其他CFD/FEA流程或自动化脚本中；
- 维护人员：用于理解接口逻辑，定位和修复后端问题。

### 1.3 技术栈
- 开发语言：C++17
- 核心依赖：VTK 9.x、CGNS API 4.x、Gmsh SDK 4.x、CMake 3.20+
- 跨平台支持：Windows/Linux/macOS
- 异常处理：基于C++异常体系，自定义异常类型

### 1.4 接口设计原则
- 模块化：按“存储-读取-写入-转换-处理”拆分模块，低耦合；
- 可扩展：预留新格式接入接口，新增格式无需修改核心逻辑；
- 异常安全：所有接口保证异常抛出后数据不泄露、资源不残留；
- 跨平台：接口不依赖特定平台API，文件路径使用UTF-8编码；
- 元数据完整：读写接口保证网格元数据（单元类型、边界条件、物理区域）不丢失。

## 2. 核心数据结构定义
### 2.1 基础枚举类型
```cpp
/**
 * @brief 网格数据类型（体/面）
 */
enum class MeshType {
    UNKNOWN = 0,
    VOLUME_MESH = 1,  // 体网格（四面体、六面体等）
    SURFACE_MESH = 2  // 面网格（三角形、四边形等）
};

/**
 * @brief 支持的网格格式
 */
enum class MeshFormat {
    UNKNOWN = 0,
    // 体网格格式
    VTK_LEGACY = 1,    // VTK Legacy (.vtk)
    VTK_XML = 2,       // VTK XML (.vtu/.vtp/.vti/.vts)
    CGNS = 3,          // CGNS (.cgns)
    GMSH_V2 = 4,       // Gmsh v2 (.msh)
    GMSH_V4 = 5,       // Gmsh v4 (.msh)
    SU2 = 6,           // SU2 (.su2)
    OPENFOAM = 7,      // OpenFOAM (foamFile)
    // 面网格格式
    STL_ASCII = 8,     // STL ASCII (.stl)
    STL_BINARY = 9,    // STL Binary (.stl)
    OBJ = 10,          // OBJ (.obj)
    PLY_ASCII = 11,    // PLY ASCII (.ply)
    PLY_BINARY = 12,   // PLY Binary (.ply)
    OFF = 13           // OFF (.off)
};

/**
 * @brief VTK单元类型（映射VTK原生定义）
 */
enum class VtkCellType {
    VERTEX = 1,
    LINE = 3,
    TRIANGLE = 5,
    QUAD = 9,
    TETRA = 10,
    HEXAHEDRON = 12,
    WEDGE = 13,
    PYRAMID = 14,
    // 扩展常用类型
    TRIANGLE_STRIP = 6,
    POLYGON = 7
};

/**
 * @brief 错误码定义
 */
enum class MeshErrorCode {
    SUCCESS = 0,                // 成功
    FILE_NOT_EXIST = 1,         // 文件不存在
    FORMAT_UNSUPPORTED = 2,     // 格式不支持
    READ_FAILED = 3,            // 读取失败（解析错误/权限问题）
    WRITE_FAILED = 4,           // 写入失败（权限问题/磁盘满）
    MESH_EMPTY = 5,             // 网格数据为空
    PARAM_INVALID = 6,          // 参数无效
    DEPENDENCY_MISSING = 7,     // 依赖库缺失（如CGNS API未加载）
    FORMAT_VERSION_INVALID = 8  // 格式版本不兼容（如Gmsh v1格式）
};
```

### 2.2 核心数据结构
```cpp
/**
 * @brief 网格元数据（描述网格属性，不包含几何/拓扑数据）
 */
struct MeshMetadata {
    std::string fileName;                // 源文件名
    MeshType meshType = MeshType::UNKNOWN; // 体/面网格类型
    MeshFormat format = MeshFormat::UNKNOWN; // 源格式
    uint64_t pointCount = 0;             // 点数量
    uint64_t cellCount = 0;             // 单元数量
    std::unordered_map<VtkCellType, uint64_t> cellTypeCount; // 各单元类型数量
    std::vector<std::string> physicalRegions; // 物理区域名称（如CFD边界条件）
    std::vector<std::string> pointDataNames;  // 点属性名称（如压力、速度）
    std::vector<std::string> cellDataNames;   // 单元属性名称（如雅可比、扭曲度）
    std::string formatVersion;           // 格式版本（如VTK 4.2、Gmsh 4.1）
};

/**
 * @brief 格式写入选项（不同格式的特异性配置）
 */
struct FormatWriteOptions {
    // 通用选项
    bool isBinary = true;                // 是否二进制存储（默认true，优先高性能）
    int precision = 6;                   // 浮点数精度（ASCII格式有效）
    bool compress = false;               // 是否压缩（仅支持VTK XML/CGNS）
    // VTK专属选项
    bool vtkPreserveAllAttributes = true; // 是否保留所有属性数据
    // CGNS专属选项
    std::string cgnsBaseName = "Base1";  // CGNS Base名称
    std::string cgnsZoneName = "Zone1";  // CGNS Zone名称
    int cgnsDimension = 3;               // CGNS物理维度（2/3）
    // Gmsh专属选项
    bool gmshPreservePhysicalGroups = true; // 是否保留物理组
    // STL专属选项
    std::string stlSolidName = "Solid";  // STL实体名称（ASCII格式）
};

/**
 * @brief 网格核心数据（几何+拓扑+属性）
 */
class MeshData {
public:
    // 几何数据：点坐标（x,y,z），连续存储
    std::vector<float> points; // 长度=pointCount*3，索引：i*3=x, i*3+1=y, i*3+2=z
    // 拓扑数据：单元连接关系
    struct Cell {
        VtkCellType type;      // 单元类型
        std::vector<uint32_t> pointIndices; // 单元包含的点索引（从0开始）
    };
    std::vector<Cell> cells;   // 所有单元
    // 属性数据：点属性（名称->值列表）
    std::unordered_map<std::string, std::vector<float>> pointData;
    // 属性数据：单元属性（名称->值列表）
    std::unordered_map<std::string, std::vector<float>> cellData;
    // 元数据
    MeshMetadata metadata;

    // 基础操作
    void clear();                          // 清空所有数据
    bool isEmpty() const;                  // 判断是否为空
    void calculateMetadata();              // 从几何/拓扑数据计算元数据
};
```

## 3. 核心接口定义
### 3.1 网格读取模块（MeshReader）
负责从文件读取网格数据到`MeshData`，支持自动格式识别和指定格式读取。

#### 3.1.1 自动识别格式并读取
```cpp
/**
 * @brief 自动识别文件格式并读取网格数据
 * @param filePath 文件路径（UTF-8编码）
 * @param[out] meshData 输出的网格数据
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息（UTF-8）
 * @return 读取是否成功（true=成功，false=失败）
 */
bool MeshReader::readAuto(const std::string& filePath,
                          MeshData& meshData,
                          MeshErrorCode& errorCode,
                          std::string& errorMsg);
```

#### 3.1.2 指定格式读取（以VTK为例，其他格式接口结构一致）
```cpp
/**
 * @brief 读取VTK格式文件（支持Legacy/XML自动识别）
 * @param filePath 文件路径（UTF-8编码）
 * @param[out] meshData 输出的网格数据
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息（UTF-8）
 * @return 读取是否成功
 */
bool MeshReader::readVTK(const std::string& filePath,
                         MeshData& meshData,
                         MeshErrorCode& errorCode,
                         std::string& errorMsg);

/**
 * @brief 读取CGNS格式文件
 * @param filePath 文件路径（UTF-8编码）
 * @param[out] meshData 输出的网格数据
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息（UTF-8）
 * @param baseIndex CGNS Base索引（默认0，第一个Base）
 * @param zoneIndex CGNS Zone索引（默认0，第一个Zone）
 * @return 读取是否成功
 */
bool MeshReader::readCGNS(const std::string& filePath,
                          MeshData& meshData,
                          MeshErrorCode& errorCode,
                          std::string& errorMsg,
                          int baseIndex = 0,
                          int zoneIndex = 0);

/**
 * @brief 读取Gmsh格式文件（支持v2/v4自动识别）
 * @param filePath 文件路径（UTF-8编码）
 * @param[out] meshData 输出的网格数据
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息（UTF-8）
 * @return 读取是否成功
 */
bool MeshReader::readGmsh(const std::string& filePath,
                          MeshData& meshData,
                          MeshErrorCode& errorCode,
                          std::string& errorMsg);
```

### 3.2 网格写入模块（MeshWriter）
负责将`MeshData`写入为指定格式的文件，支持格式特异性配置。

#### 3.2.1 通用写入接口
```cpp
/**
 * @brief 写入网格数据到指定格式文件
 * @param meshData 输入的网格数据
 * @param filePath 输出文件路径（UTF-8编码）
 * @param targetFormat 目标格式
 * @param options 写入选项（格式特异性配置）
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息（UTF-8）
 * @return 写入是否成功
 */
bool MeshWriter::write(const MeshData& meshData,
                       const std::string& filePath,
                       MeshFormat targetFormat,
                       const FormatWriteOptions& options,
                       MeshErrorCode& errorCode,
                       std::string& errorMsg);
```

#### 3.2.2 格式专属写入接口（可选，用于精细化控制）
```cpp
/**
 * @brief 写入VTK格式文件（自动区分Legacy/XML）
 * @param meshData 输入的网格数据
 * @param filePath 输出文件路径（UTF-8编码）
 * @param isXml 是否写入XML格式（false=Legacy，true=XML）
 * @param options 写入选项
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息
 * @return 写入是否成功
 */
bool MeshWriter::writeVTK(const MeshData& meshData,
                          const std::string& filePath,
                          bool isXml,
                          const FormatWriteOptions& options,
                          MeshErrorCode& errorCode,
                          std::string& errorMsg);

/**
 * @brief 写入CGNS格式文件
 * @param meshData 输入的网格数据
 * @param filePath 输出文件路径（UTF-8编码）
 * @param options 写入选项（需指定cgnsBaseName/cgnsZoneName等）
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息
 * @return 写入是否成功
 */
bool MeshWriter::writeCGNS(const MeshData& meshData,
                           const std::string& filePath,
                           const FormatWriteOptions& options,
                           MeshErrorCode& errorCode,
                           std::string& errorMsg);
```

### 3.3 格式转换模块（MeshConverter）
封装“读取-处理-写入”全流程，提供一键格式转换能力。

#### 3.3.1 单文件转换
```cpp
/**
 * @brief 单文件格式转换
 * @param srcFilePath 源文件路径（UTF-8）
 * @param dstFilePath 目标文件路径（UTF-8）
 * @param srcFormat 源格式（MeshFormat::UNKNOWN=自动识别）
 * @param dstFormat 目标格式
 * @param writeOptions 目标格式写入选项
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息
 * @return 转换是否成功
 */
bool MeshConverter::convert(const std::string& srcFilePath,
                            const std::string& dstFilePath,
                            MeshFormat srcFormat,
                            MeshFormat dstFormat,
                            const FormatWriteOptions& writeOptions,
                            MeshErrorCode& errorCode,
                            std::string& errorMsg);
```

#### 3.3.2 批量转换
```cpp
/**
 * @brief 批量转换多个文件
 * @param srcFilePaths 源文件路径列表（UTF-8）
 * @param dstDir 目标目录（UTF-8）
 * @param dstFormat 目标格式
 * @param writeOptions 目标格式写入选项
 * @param[out] errorMap 输出每个文件的错误信息（key=源文件路径，value=(errorCode, errorMsg)）
 * @return 成功转换的文件数量
 */
uint64_t MeshConverter::batchConvert(const std::vector<std::string>& srcFilePaths,
                                     const std::string& dstDir,
                                     MeshFormat dstFormat,
                                     const FormatWriteOptions& writeOptions,
                                     std::unordered_map<std::string, std::pair<MeshErrorCode, std::string>>& errorMap);
```

### 3.4 网格处理模块（MeshProcessor）
提供网格拓扑/几何处理能力，如体网格提取表面、面网格转体网格等。

```cpp
/**
 * @brief 从体网格提取表面网格（生成闭合壳体）
 * @param volumeMesh 输入体网格数据
 * @param[out] surfaceMesh 输出表面网格数据
 * @param includeBoundaryOnly 是否仅提取边界单元（true=仅边界，false=所有表面）
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息
 * @return 处理是否成功
 */
bool MeshProcessor::extractSurfaceFromVolume(const MeshData& volumeMesh,
                                             MeshData& surfaceMesh,
                                             bool includeBoundaryOnly,
                                             MeshErrorCode& errorCode,
                                             std::string& errorMsg);

/**
 * @brief 网格数据校验（检查点/单元索引、属性数据长度等）
 * @param meshData 待校验的网格数据
 * @param[out] errorMsg 输出校验失败信息
 * @return 校验是否通过
 */
bool MeshProcessor::validateMesh(const MeshData& meshData, std::string& errorMsg);
```

### 3.5 辅助接口（MeshHelper）
提供格式识别、元数据提取等辅助能力。

```cpp
/**
 * @brief 从文件头识别网格格式
 * @param filePath 文件路径（UTF-8）
 * @return 识别出的格式（MeshFormat::UNKNOWN=无法识别）
 */
MeshFormat MeshHelper::detectFormat(const std::string& filePath);

/**
 * @brief 提取网格元数据（不加载完整几何/拓扑数据，提升性能）
 * @param filePath 文件路径（UTF-8）
 * @param[out] metadata 输出元数据
 * @param[out] errorCode 输出错误码
 * @param[out] errorMsg 输出错误信息
 * @return 提取是否成功
 */
bool MeshHelper::extractMetadata(const std::string& filePath,
                                 MeshMetadata& metadata,
                                 MeshErrorCode& errorCode,
                                 std::string& errorMsg);
```

## 4. 异常定义
自定义异常类，用于接口抛出结构化异常信息：
```cpp
class MeshException : public std::exception {
private:
    MeshErrorCode errorCode_;
    std::string errorMsg_;
public:
    MeshException(MeshErrorCode code, const std::string& msg) 
        : errorCode_(code), errorMsg_(msg) {}

    MeshErrorCode getErrorCode() const { return errorCode_; }
    const char* what() const noexcept override { return errorMsg_.c_str(); }
};
```

## 5. 使用示例
### 5.1 单文件转换（VTK→CGNS）
```cpp
#include "MeshConverter.h"
#include "MeshWriter.h"
#include "MeshHelper.h"

int main() {
    // 1. 定义参数
    std::string srcPath = "input.vtk";
    std::string dstPath = "output.cgns";
    MeshFormat srcFormat = MeshHelper::detectFormat(srcPath);
    MeshFormat dstFormat = MeshFormat::CGNS;
    FormatWriteOptions writeOptions;
    // 配置CGNS专属选项
    writeOptions.cgnsBaseName = "CFD_Base";
    writeOptions.cgnsZoneName = "Flow_Zone";
    writeOptions.cgnsDimension = 3;
    writeOptions.isBinary = true;

    // 2. 执行转换
    MeshErrorCode errorCode;
    std::string errorMsg;
    bool success = MeshConverter::convert(srcPath, dstPath, srcFormat, dstFormat, writeOptions, errorCode, errorMsg);

    // 3. 结果判断
    if (success) {
        std::cout << "转换成功！" << std::endl;
    } else {
        std::cerr << "转换失败：" << errorMsg << "（错误码：" << (int)errorCode << "）" << std::endl;
    }

    return success ? 0 : 1;
}
```

### 5.2 读取网格并提取元数据
```cpp
#include "MeshReader.h"
#include "MeshHelper.h"

int main() {
    std::string filePath = "mesh.msh";
    MeshMetadata metadata;
    MeshErrorCode errorCode;
    std::string errorMsg;

    // 提取元数据
    if (MeshHelper::extractMetadata(filePath, metadata, errorCode, errorMsg)) {
        std::cout << "网格类型：" << (metadata.meshType == MeshType::VOLUME_MESH ? "体网格" : "面网格") << std::endl;
        std::cout << "点数量：" << metadata.pointCount << std::endl;
        std::cout << "单元数量：" << metadata.cellCount << std::endl;
    } else {
        std::cerr << "提取元数据失败：" << errorMsg << std::endl;
    }

    // 读取完整网格数据
    MeshData meshData;
    if (MeshReader::readAuto(filePath, meshData, errorCode, errorMsg)) {
        std::cout << "读取网格成功，单元数：" << meshData.cells.size() << std::endl;
    } else {
        std::cerr << "读取网格失败：" << errorMsg << std::endl;
    }

    return 0;
}
```

## 6. 接口扩展规范
### 6.1 新增网格格式
1. 在`MeshFormat`枚举中添加新格式值；
2. 实现`MeshReader`的`readXXX`方法，解析新格式到`MeshData`；
3. 实现`MeshWriter`的`writeXXX`方法，将`MeshData`序列化为新格式；
4. 在`MeshHelper::detectFormat`中添加新格式的识别逻辑；
5. 补充`FormatWriteOptions`中的格式特异性配置；
6. 编写单元测试，覆盖新格式的读写/转换场景。

### 6.2 新增网格处理能力
1. 在`MeshProcessor`中添加新方法，入参为`MeshData`（const引用），出参为处理后的`MeshData`；
2. 保证方法的异常安全，抛出`MeshException`并定义对应的`MeshErrorCode`；
3. 补充单元测试，验证处理逻辑的正确性。

## 7. 版本兼容性
- 接口版本：v1.0（与Qt6/C++17兼容）；
- 向后兼容：新增接口不修改原有接口签名，仅扩展；
- 依赖版本：
  - VTK ≥ 9.0
  - CGNS API ≥ 4.0
  - Gmsh SDK ≥ 4.1
  - C++ ≥ 17

## 8. 性能说明
- 读取大文件（>1GB）：建议使用二进制格式，开启内存映射（mmap）；
- 批量转换：接口内部使用多线程（std::thread），默认线程数=CPU核心数；
- 内存占用：非结构化网格内存占用≈(点数量×12字节)+(单元数量×平均单元点数×4字节)+属性数据大小。